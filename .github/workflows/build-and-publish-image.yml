name: Build and publish CLI image

on:
  push:
    branches: [ "main", "feature/**" ]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push-cli-image:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # needed for tags & changelog

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: '25'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          cache: maven

      - name: Read Project Version
        id: pomversion
        run: |
          echo "version=$(./mvnw -q -Dexec.executable=echo -Dexec.args='${project.version}' --non-recursive exec:exec)" >> $GITHUB_OUTPUT

      # If on main, create a release version without -SNAPSHOT
      - name: Set Release Version
        id: version
        run: |
          set -euo pipefail
          pomversion="${{ steps.pomversion.outputs.version }}"
          REL="${pomversion%-SNAPSHOT}"
          echo "Set version to $REL"
          ./mvnw -q versions:set -DnewVersion="$REL" -DgenerateBackupPoms=false
          echo "version=$REL" >> $GITHUB_OUTPUT

      # Fail if a git tag for this version already exists
      - name: Ensure Version Tag does not Already Exist
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          git fetch --tags --force
          TAG="${{ steps.version.outputs.version }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Error: tag '${TAG}' already exists. Bump the project version before releasing."
            exit 1
          fi

      - name: Show Java Versions
        run: |
          java -version

      - name: Run Trivy Security Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'repo'
          scan-ref: '.'
          format: 'table'
          exit-code: '1'
          severity: 'CRITICAL,HIGH'
          scanners: 'vuln,secret,misconfig'
          trivy-config: '.trivyconfig.yaml'

      - name: Maven Build
        run: ./mvnw -B -ntp -Pnative package

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Container Image
        uses: docker/build-push-action@v6
        with:
          context: ./jeap-cli
          platforms: linux/amd64
          # Push only on main; feature branches build only
          push: ${{ github.ref == 'refs/heads/main' }}
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ github.ref == 'refs/heads/main' && format('{0}/{1}:latest', env.REGISTRY, env.IMAGE_NAME) || '' }}

      # Find previous tag (before a new one is created) for changelog
      - name: Determine Previous Tag
        if: github.ref == 'refs/heads/main'
        id: previoustag
        run: |
          set -euo pipefail
          git fetch --tags --force
          # Try semantic sort first, fall back to most recent by date
          PREV="$(git tag --sort=-version:refname | head -n 1 || true)"
          if [ -z "$PREV" ]; then
            PREV="$(git for-each-ref --sort=-creatordate --format '%(refname:short)' refs/tags | head -n 1 || true)"
          fi
          echo "prev_tag=$PREV" >> "$GITHUB_OUTPUT"

      # Create git tag for released version and push it
      - name: Create and Push Git Tag
        if: github.ref == 'refs/heads/main'
        run: |
          set -euo pipefail
          TAG="${{ steps.version.outputs.version }}"
          git config user.name "${{ github.actor }}"
          git config user.email "${{ github.actor }}@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG"
          git push origin "$TAG"

      # Resolve GHCR package page and the specific version page (org-scoped)
      - name: Get GitHub Container Registry Version URL
        if: github.ref == 'refs/heads/main'
        id: packageurl
        uses: actions/github-script@v8
        with:
          script: |
            const wantedTag = "${{ steps.version.outputs.version }}";
            console.log(`Looking for GHCR version with tag: ${wantedTag}`);
            
            // List all versions and find the one that carries the desired tag
            const versions = await github.paginate(
              "GET /orgs/jeap-admin-ch/packages/container/jeap-cli/versions",
              {
                per_page: 100
              }
            );
            
            console.log(`Found ${versions.length} GHCR versions`);
            
            const match = versions.find(v => {
              console.log(`Checking version: ${v.id} with tags: ${v?.metadata?.container?.tags || []}`);
              console.log(`Looking for tag: ${wantedTag}`);
              const hasMatchingTag = (v?.metadata?.container?.tags || []).includes(wantedTag)
              console.log(`Has matching tag: ${hasMatchingTag}`);
              return hasMatchingTag
            });
            
            console.log(`Resolved GHCR version URL: ${match?.html_url || "NOT FOUND"}`);
            core.setOutput("url", match?.html_url);

      # Generate release notes with link and changelog since previous tag
      - name: Generate Release Notes
        if: github.ref == 'refs/heads/main'
        id: releasenotes
        env:
          VERSION: "${{ steps.version.outputs.version }}"
          PREV: "${{ steps.previoustag.outputs.prev_tag }}"
          PKG_VER_URL: "${{ steps.packageurl.outputs.url }}?tag=${{ steps.version.outputs.version }}"
        run: |
          set -euo pipefail
          IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${VERSION}"
          {
            echo "# Release ${VERSION}"
            echo
            echo "Container image:"
            echo
            echo "\`${IMAGE_REF}\`"
            echo
            if [ -n "$PKG_VER_URL" ]; then
              echo "[View this version on GitHub Packages](${PKG_VER_URL})"
            fi
            echo
            if [ -n "$PREV" ]; then
              echo "## Changelog since \`${PREV}\`"
              echo
              git log --no-merges --pretty=format:'- %s (%h)' "${PREV}..HEAD" || true
            else
              echo "## Changelog"
              echo
              git log --no-merges --pretty=format:'- %s (%h)' || true
            fi
            echo
          } > RELEASE_NOTES.md
          echo "body_path=RELEASE_NOTES.md" >> $GITHUB_OUTPUT

      # Publish GitHub release for this version with notes
      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: ${{ steps.version.outputs.version }}
          body_path: ${{ steps.releasenotes.outputs.body_path }}
          make_latest: true
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
